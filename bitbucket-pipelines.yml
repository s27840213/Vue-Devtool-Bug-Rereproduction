image: node:14.16.0

pipelines:
  default: #for feature
    - parallel:
        - step:
            name: "Verify build environment"
            script: #show node and yarn version
              - node -v
              - yarn -v
        - step:
            name: "Start build with node module cache"
            size: 2x
            caches: #set caches for node modules to speed up building
              - node
            image: cypress/browsers:node14.17.0-chrome88-ff89
            script:
              - yarn install
              - yarn build:prerender
            artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
              - dist/**
        # - step:
        #     name: 'Run E2E Tests'
        #     caches:
        #       - node
        #     image: cypress/browsers:node14.17.0-chrome88-ff89
        #     script:
        #       - npx cypress install
        #       - yarn install
        #       - yarn serve & npx wait-on http://localhost:8080
        #       - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
    - parallel:
        - step:
            name: "dev5 Alan"
            deployment: dev5
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV5
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV5
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV5
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "dev4 Gary"
            deployment: dev4
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV4
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV4
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV4
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "dev3 HsingChi"
            deployment: dev3
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "dev2 TingAn"
            deployment: dev2
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "dev1 Nathan"
            deployment: dev1
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV1
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV1
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV1
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "dev0"
            deployment: dev0
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV0
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV0
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_DEV0
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "test2"
            deployment: test2
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST2
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "test3"
            deployment: test3
            trigger: manual
            script:
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=* --include=app.html"
              - pipe: atlassian/aws-s3-deploy:1.1.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                  S3_BUCKET: $AWS_BUCKET_TEST3
                  LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                  EXTRA_ARGS: "--exclude=*.js.map"
                  DELETE_FLAG: "true"
        - step:
            name: "create pull request"
            trigger: manual
            script:
              - ./bash/create_pull_request.sh
  branches:
    master:
      - parallel:
          - step:
              name: "Verify build environment"
              script: #show node and yarn version
                - node -v
                - yarn -v
          - step:
              name: "Start build with node module cache"
              size: 2x
              caches: #set caches for node modules to speed up building
                - node
              image: cypress/browsers:node14.17.0-chrome88-ff89
              script:
                - yarn install
                - yarn build:prerender
              artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
                - dist/**
          # - step:
          #     name: 'Run E2E Tests'
          #     caches:
          #       - node
          #     image: cypress/browsers:node14.17.0-chrome88-ff89
          #     script:
          #       - npx cypress install
          #       - yarn install
          #       - yarn serve & npx wait-on http://localhost:8080
          #       - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
      - step:
          name: "deploy test"
          deployment: test
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                S3_BUCKET: $AWS_BUCKET_TEST
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                S3_BUCKET: $AWS_BUCKET_TEST
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=* --include=app.html"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                S3_BUCKET: $AWS_BUCKET_TEST
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=*.js.map"
                DELETE_FLAG: "true"
      - step:
          name: "deploy edit"
          deployment: staging
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_EDIT
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_EDIT
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_EDIT
                S3_BUCKET: $AWS_BUCKET_EDIT
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_EDIT
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_EDIT
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_EDIT
                S3_BUCKET: $AWS_BUCKET_EDIT
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=* --include=app.html"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_EDIT
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_EDIT
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_EDIT
                S3_BUCKET: $AWS_BUCKET_EDIT
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=*.js.map"
                DELETE_FLAG: "true"
            - curl -k -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" -H "X-Auth-Email:$CF_MAIL" -H "X-Auth-Key:$CF_KEY" -H "Content-Type:application/json" --data '{"purge_everything":true}'
      - step:
          name: "deploy prod"
          deployment: production
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_PROD
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_PROD
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_PROD
                S3_BUCKET: $AWS_BUCKET_PROD
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_PROD
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_PROD
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_PROD
                S3_BUCKET: $AWS_BUCKET_PROD
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=* --include=app.html"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_PROD
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_PROD
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_PROD
                S3_BUCKET: $AWS_BUCKET_PROD
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=*.js.map"
                DELETE_FLAG: "true"
            - curl -k -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" -H "X-Auth-Email:$CF_MAIL" -H "X-Auth-Key:$CF_KEY" -H "Content-Type:application/json" --data '{"purge_everything":true}'
    develop:
      - parallel:
          - step:
              name: "Verify build environment"
              script: #show node and yarn version
                - node -v
                - yarn -v
          - step:
              name: "Start build with node module cache"
              size: 2x
              caches: #set caches for node modules to speed up building
                - node
              image: cypress/browsers:node14.17.0-chrome88-ff89
              script:
                - yarn install
                - yarn build:prerender
              artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
                - dist/**
          # - step:
          #     name: 'Run E2E Tests'
          #     caches:
          #       - node
          #     image: cypress/browsers:node14.17.0-chrome88-ff89
          #     script:
          #       - npx cypress install
          #       - yarn install
          #       - yarn serve & npx wait-on http://localhost:8080
          #       - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
      - parallel:
          - step:
              name: "deploy rd"
              deployment: rd
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_RD
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_RD
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_RD
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "test3"
              deployment: test3
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_TEST3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_TEST3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_TEST3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "create pull request"
              trigger: manual
              script:
                - ./bash/create_pull_request.sh
    hotfix: #for non-master and non-develop branch, i.e., feature or hotfix...
      - parallel:
          - step:
              name: "Verify build environment"
              script: #show node and yarn version
                - node -v
                - yarn -v
          - step:
              name: "Start build with node module cache"
              size: 2x
              caches: #set caches for node modules to speed up building
                - node
              image: cypress/browsers:node14.17.0-chrome88-ff89
              script:
                - yarn install
                - yarn build:prerender
              artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
                - dist/**
          # - step:
          #     name: 'Run E2E Tests'
          #     caches:
          #       - node
          #     image: cypress/browsers:node14.17.0-chrome88-ff89
          #     script:
          #       - npx cypress install
          #       - yarn install
          #       - yarn serve & npx wait-on http://localhost:8080
          #       - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
      - parallel:
          - step:
              name: "dev5 Alan"
              deployment: dev5
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV5
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV5
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV5
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "dev4 Gary"
              deployment: dev4
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV4
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV4
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV4
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "dev3 HsingChi"
              deployment: dev3
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV3
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "dev2 TingAn"
              deployment: dev2
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV2
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV2
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV2
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "dev1 Nathan"
              deployment: dev1
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV1
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV1
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV1
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "dev0"
              deployment: dev0
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV0
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=app.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV0
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=app.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                    S3_BUCKET: $AWS_BUCKET_DEV0
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "stickertest"
              deployment: stickertest
              trigger: manual
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                    S3_BUCKET: $AWS_BUCKET_STICKERTEST
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=index.html --exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                    S3_BUCKET: $AWS_BUCKET_STICKERTEST
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=* --include=index.html"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                    S3_BUCKET: $AWS_BUCKET_STICKERTEST
                    LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "create pull request"
              trigger: manual
              script:
                - ./bash/create_pull_request.sh
    app/vivisticker:
      - parallel:
          - step:
              name: "Verify build environment"
              script: #show node and yarn version
                - node -v
                - yarn -v
          - step:
              name: "Start build with node module cache"
              size: 2x
              caches: #set caches for node modules to speed up building
                - node
              script:
                - yarn install
                - yarn build
              artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
                - dist/**
          # - step:
          #     name: 'Run E2E Tests'
          #     caches:
          #       - node
          #     image: cypress/browsers:node14.17.0-chrome88-ff89
          #     script:
          #       - npx cypress install
          #       - yarn install
          #       - yarn serve & npx wait-on http://localhost:8080
          #       - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
      - step:
          name: "deploy prod"
          deployment: stickerproduction
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                S3_BUCKET: $AWS_BUCKET_STICKER
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=index.html --exclude=*.js.map"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                S3_BUCKET: $AWS_BUCKET_STICKER
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=* --include=index.html"
            - pipe: atlassian/aws-s3-deploy:1.1.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_STICKER
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_STICKER
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_STICKER
                S3_BUCKET: $AWS_BUCKET_STICKER
                LOCAL_PATH: "dist" #should be the same as the output folder (artifacts)
                EXTRA_ARGS: "--exclude=*.js.map"
                DELETE_FLAG: "true"
            - curl -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" -H "X-Auth-Email:$CF_MAIL" -H "X-Auth-Key:$CF_KEY" -H "Content-Type:application/json" --data '{"purge_everything":true}'
