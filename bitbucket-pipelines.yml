image: node:14.16.0

pipelines:
  default:
    - parallel:
        - step:
            name: 'Verify build environment'
            script: #show node and yarn version
              - node -v
              - yarn -v
        - step:
            name: 'Start build with node module cache'
            caches: #set caches for node modules to speed up building
              - node
            script:
              - yarn install
              - yarn build
            artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
              - dist/**
        - step:
            name: 'Run E2E Tests'
            caches:
              - node
            image: cypress/browsers:node14.17.0-chrome88-ff89
            script:
              - npx cypress install
              - yarn install
              - yarn serve & npx wait-on http://localhost:8080
              - npx cypress run --record --browser chrome --key $CYPRESS_RECORD_KEY || true
    - parallel:
      - step:
          name: 'Deploy to S3 test2 environment'
          deployment: test2
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:0.5.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                S3_BUCKET: $AWS_BUCKET_TEST2
                LOCAL_PATH: 'dist' #should be the same as the output folder (artifacts)
                EXTRA_ARGS: '--delete' #remove files or objects from the target that are not present in the source
            #no cache for test environment (since free cloudflare can not remove cache by host)
            - pipe: atlassian/email-notify:0.4.5
              variables:
                USERNAME: 'nuphoto.mail@gmail.com'
                PASSWORD: $EMAIL_NOTIFY_PASSWORD
                FROM: 'nuphoto.mail@gmail.com'
                TO: 'nuphoto.bruce.486idj@zapiermail.com'
                HOST: 'smtp.gmail.com'
                SUBJECT: 'NEW TEST2 DEPLOYED'
      - step:
          name: 'Deploy to S3 test3 environment'
          deployment: test3
          trigger: manual
          script:
            - pipe: atlassian/aws-s3-deploy:0.5.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION_TEST
                S3_BUCKET: $AWS_BUCKET_TEST3
                LOCAL_PATH: 'dist' #should be the same as the output folder (artifacts)
                EXTRA_ARGS: '--delete' #remove files or objects from the target that are not present in the source
            #no cache for test environment (since free cloudflare can not remove cache by host)
            - pipe: atlassian/email-notify:0.4.5
              variables:
                USERNAME: 'nuphoto.mail@gmail.com'
                PASSWORD: $EMAIL_NOTIFY_PASSWORD
                FROM: 'nuphoto.mail@gmail.com'
                TO: 'nuphoto.bruce.486idj@zapiermail.com'
                HOST: 'smtp.gmail.com'
                SUBJECT: 'NEW TEST3 DEPLOYED'