image: node:16.19.1

definitions:
  caches:
    pnpm: $BITBUCKET_CLONE_DIR/.pnpm-store

pipelines:
  branches:
    develop:
      - parallel:
          - step:
              name: "Verify build environment"
              script: #show node and pnpm version
                - corepack enable
                - corepack prepare pnpm@latest-8 --activate
                - node -v
                - pnpm -v
          - step:
              name: "Start build with node module cache"
              size: 2x
              caches: #set caches for node modules to speed up building
                - pnpm
              image: cypress/browsers:node-16.18.1-chrome-109.0.5414.74-1-ff-109.0-edge-109.0.1518.52-1
              script:
                - corepack enable
                - corepack prepare pnpm@latest-8 --activate
                - pnpm install
                - pnpm run build-all # Replace with your build/testâ€¦etc. commands
              artifacts: #single asterisk (*) to match files in folder, double asterisk (**) to match files and folders in folder
                - projects/*/dist/**
                - projects/*/node_modules/**
      - parallel:
          - step:
              name: "deploy charmix to rd"
              deployment: rd
              trigger: manual
              condition:
                changesets:
                  includePaths:
                    - "projects/charmix/**"
                    - "packages/**"
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/charmix/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/charmix/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/charmix/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          - step:
              name: "deploy vivipic to rd"
              deployment: rd
              trigger: manual
              condition:
                changesets:
                  includePaths:
                    - "projects/vivipic/**"
                    - "packages/**"
              script:
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/vivipic/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/vivipic/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*"
                - pipe: atlassian/aws-s3-deploy:1.1.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
                    S3_BUCKET: $AWS_BUCKET
                    LOCAL_PATH: "projects/vivipic/dist" #should be the same as the output folder (artifacts)
                    EXTRA_ARGS: "--exclude=*.js.map"
                    DELETE_FLAG: "true"
          # - step:
          #     name: "create pull request"
          #     trigger: manual
          #     script:
          #       - ./bash/create_pull_request.sh
