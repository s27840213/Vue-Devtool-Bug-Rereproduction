<template lang="pug">
div(class="panel-text-effect")
  //- To choose effect category and effect.
  tabs(v-if="state === 'effects'"
      :tabs="textEffects.map(t => t.label)"
      v-model="currTabIndex" :theme="$isStk ? 'dark-stk' : 'light'")
  div(v-if="state === 'effects'"
      class="panel-text-effect__effects")
    div(v-for="effect in effectList"
        :key="`${currCategoryName}-${effect.key}`"
        :class="{ 'selected': currEffect?.key === effect.key }"
        @click="onEffectClick(currCategory, effect)")
      div(class="panel-text-effect__effects__icon-bg")
      svg-icon(v-if="['custom-fill-img', 'none'].includes(effect.key)"
              :iconName="effectIcon(currCategory, effect).name"
              :iconWidth="effectIcon(currCategory, effect).size"
              class="panel-text-effect__effects--icon" :iconColor="theme === 'dark' ? 'white' : 'black-2'")
      img(v-else :src="effectIcon(currCategory, effect).name"
          class="panel-text-effect__effects--icon"
          :width="effectIcon(currCategory, effect).size"
          :height="effectIcon(currCategory, effect).size")
      pro-item(v-if="effect.plan" theme="roundedRect")
      div(v-if="currEffect?.key === effect.key && effect.key !== 'none'"
          class="panel-text-effect__effects--more")
        svg-icon(iconName="sliders" iconWidth="20px" iconColor="white")
  //- To set effect optoin.
  div(v-if="state === 'options' && currEffect !== null"
      class="w-full panel-text-effect__form")
    span(class="panel-text-effect__effect-name") {{currEffect.label}}
    div(v-for="option in currEffect.options"
        :key="option.key"
        class="panel-text-effect__field"
        :class="{disabled: optionDisabled(option)}")
      div(v-if="option.key !== 'endpoint' && !['range', 'color'].includes(option.type)"
          class="panel-text-effect__option-name") {{option.label}}
      //- Option type select (endpoint)
      div(v-if="option.type === 'select' && option.key === 'endpoint'"
          class="panel-text-effect__endpoint")
        div(v-for="sel in option.select"
            :key="sel.key"
            :class="{'selected': currentStyle[option.key] === sel.key }"
            @click="handleSelectInput(sel)")
          img(:src="sel.img")
          span {{sel.label}}
      //- Option type select
      div(v-if="option.type === 'select' && option.key !== 'endpoint'"
          class="panel-text-effect__select")
        div(v-for="sel in option.select" :key="sel.key"
            @click="handleSelectInput(sel)")
          img(:src="sel.img"
              :class="{'selected': ((currentStyle[option.key] as Record<'key', string>).key ?? currentStyle[option.key]) === sel.key }")
          pro-item(v-if="sel.plan" theme="roundedRect")
      //- Option type range
      mobile-slider(v-if="option.type === 'range'"
        :borderTouchArea="true"
        :title="option.label"
        :value="getInputValue(currentStyle, option)"
        :max="option.max"
        :min="option.min"
        :step="option.key === 'lineHeight' ? 0.01 : 1"
        :autoRecord="false"
        :disabled="optionDisabled(option)"
        @update="(val)=>handleRangeInput(val, option)"
        @pointerdown="setEffectFocus(true)"
        @pointerup="setEffectFocus(false)"
        @pointercancel="setEffectFocus(false)")
      //- Option type color
      div(v-if="option.type === 'color'"
        class="panel-text-effect__color")
        div {{option.label}}
        color-btn(:color="colorParser(currentStyle[option.key] as string)"
                :disable="optionDisabled(option)"
                size="30px" @click="openColorPanel(option.key)")
      //- Option type img
      div(v-if="option.type === 'img'"
          class="panel-text-effect__img"
          @click="chooseImg(option.key)")
        img(:src="getStyleImg")
        div
        svg-icon(class="absolute" iconName="replace" iconColor="white" iconWidth="32px")
    nubtn(class="panel-text-effect__reset"
          theme="icon_pill"
          :icon="['reset-sm', 'white']"
          size="sm"
          @click="resetTextEffect()") {{$t('NN0754')}}
</template>

<script lang="ts">
import Tabs from '@/components/Tabs.vue'
import MobileSlider from '@/components/editor/mobile/MobileSlider.vue'
import PanelTextEffectSetting from '@/components/editor/panelFunction/PanelTextEffectSetting.vue'
import ColorBtn from '@/components/global/ColorBtn.vue'
import ProItem from '@/components/payment/ProItem.vue'
import { ColorEventType, MobileColorPanelType } from '@/store/types'
import colorUtils from '@/utils/colorUtils'
import { IEffect, IEffectCategory } from '@/utils/constantData'
import localStorageUtils from '@/utils/localStorageUtils'
import paymentUtils from '@/utils/paymentUtils'
import stkWVUtils from '@/utils/stkWVUtils'
import textBgUtils from '@/utils/textBgUtils'
import textEffectUtils from '@/utils/textEffectUtils'
import _ from 'lodash'
import { PropType, defineComponent } from 'vue'

export default defineComponent({
  name: 'MobilePanelTextEffectSetting',
  extends: PanelTextEffectSetting, // Check desktop TextEffect for common variable
  components: {
    MobileSlider,
    ColorBtn,
    ProItem,
    Tabs,
  },
  props: {
    panelHistory: {
      type: Array as PropType<string[]>,
      default: [] as string[]
    }
  },
  emits: ['pushHistory', 'openExtraColorModal', 'openExtraPanelReplace'],
  data() {
    return {
    }
  },
  computed: {
    currTabIndex: {
      get: function (): number {
        return {
          shadow: 0,
          shape: 1,
          bg: 2,
          fill: 3
        }[this.currTab as 'shadow'|'bg'|'shape'|'fill'] ?? 0
      },
      set: function (newVal: number) {
        this.currTab = ['shadow', 'shape', 'bg', 'fill'][newVal] ?? 0
        localStorageUtils.set('textEffectSetting', 'tab', this.currTab)
      }
    },
    currCategory(): IEffectCategory {
      return _.find(this.textEffects, ['name', this.currCategoryName]) as IEffectCategory
    },
    effectList(): IEffect[] | null {
      if (!this.currCategory) return null
      return _.flatten(this.currCategory.effects2d)
    },
    currEffect(): IEffect | null {
      if (!this.currCategory) return null
      return _.find(this.effectList, ['key', this.currentStyle.name]) ?? null
    },
    state(): string {
      if (this.currCategoryName === 'fill' &&
        this.currEffect?.options.some(op => op.type === 'img') &&
        !this.currentStyle.customImg) return 'effects' // No customImg, no options.
      return this.panelHistory.length === 0 ? 'effects' : 'options'
    },
    iconBgColor(): string {
      return (this.theme === 'dark' ? colorUtils.colorMap.get('black-3') : colorUtils.colorMap.get('gray-5')) ?? 'white'
    },
    moreBgColor(): string {
      return this.theme === 'dark' ? 'rgba(20, 20, 20, 0.5)' : 'rgba(71, 74, 87, 0.6)'
    }
  },
  mounted() { /**/ },
  beforeUnmount() { /**/ },
  methods: {
    openColorPanel(key: string) {
      if (this.currCategoryName === 'shadow') {
        colorUtils.setCurrEvent(ColorEventType.textEffect)
        this.$emit('openExtraColorModal', ColorEventType.textEffect, MobileColorPanelType.palette)
        textEffectUtils.setColorKey(key)
      } else { // Text BG
        colorUtils.setCurrEvent(ColorEventType.textBg)
        this.$emit('openExtraColorModal', ColorEventType.textBg, MobileColorPanelType.palette)
        textBgUtils.setColorKey(key)
      }
    },
    async onEffectClick(category: IEffectCategory, effect: IEffect): Promise<void> {
      if (this.$isPic && !paymentUtils.checkPro(effect, 'pro-text')) return
      if (this.$isStk && !stkWVUtils.checkPro(effect, 'text')) return
      const chooseImgkey = effect.options.find(op => op.type === 'img')?.key ?? ''

      if (effect.key !== this.currentStyle.name) {
        await this.setEffect({ effectName: effect.key })
        this.recordChange()
        if (chooseImgkey && !this.getStyleImg) {
          this.chooseImg(chooseImgkey)
        }
      } else if (effect.key !== 'none') {
        if (chooseImgkey && !this.getStyleImg) {
          this.chooseImg(chooseImgkey)
          return
        }
        this.$emit('pushHistory', effect.key)
      }
    },
    chooseImg(key: string) {
      this.$emit('openExtraPanelReplace', this.replaceImg(key))
    },
  }
})
</script>

<style lang="scss" scoped>
.panel-text-effect {
  @include body-SM;
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-rows: auto minmax(0, 1fr);
  grid-template-columns: 1fr;
  @include setColors(gray-2, white) using ($color) {
    color: $color;
  }
  text-align: left;

  :deep(.tabs) {
    height: 26px;
    margin-bottom: 10px;
    .tabs__item {
      padding-bottom: 2px;
    }
    span {
      @include body-XS;
    }
  }

  :deep(.color-btn__color) {
    @include setColors(gray-4, black-5) using ($color) {
      border-color: $color;
    }
  }

  &__categories {
    @include no-scrollbar;
    width: 100%;
    display: flex;
    border-radius: 5px;
    overflow-x: scroll;
    padding-top: 2px;
    padding-bottom: 20px;
  }

  &__effects {
    @include no-scrollbar;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
    gap: 15px;
    margin: 0 13px 13px 13px;
    padding: 2px 0; // For first/last rows icon border space.
    overflow: auto;
    > div {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      width: 56px;
      height: 56px;
      margin: 0px auto;
      border-radius: 5px;
      overflow: hidden;
      box-sizing: border-box;
      transition: border 0.3s;
      &.selected {
        @include setColors(blue-1, white) using ($color) {
          border: 2px solid $color;
        }
        > img, > svg {
          transform: scale(0.85);
        }
        > div {
          border-radius: 3px;
          width: 47.6px;
          height: 47.6px;
        }
      }
      .panel-text-effect__effects--icon {
        border-radius: 5px;
        object-fit: cover;
        pointer-events: none;
      }
    }
    &__icon-bg {
      z-index: -1;
      border-radius: 5px;
      background-color: v-bind(iconBgColor);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 56px;
      height: 56px;
      transition: width 0.3s, height 0.3s;
    }
    &--more {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 56px;
      height: 56px;
      border-radius: 3px;
      background: v-bind(moreBgColor);
      backdrop-filter: blur(2px);
      transition: width 0.3s, height 0.3s;
    }
  }

  &__form {
    @include no-scrollbar;
    display: grid;
    gap: 10px;
    margin: 0 15px 15px 15px;
    overflow-y: scroll;
  }

  &__field {
    &.disabled {
      :deep(*) {
        @include setColors(gray-4, black-3-5) using ($color) {
          color: $color;
        }
        pointer-events: none;
      }
    }
  }

  &__effect-name {
    @include setColors(gray-1, white) using ($color) {
      color: $color;
    }
    text-align: center;
  }

  &__option-name {
    margin-bottom: 4px;
  }

  &__endpoint {
    display: grid;
    grid-auto-flow: column;
    grid-gap: 18px;
    padding: 10px;
    > div {
      @include btn-SM;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      height: 42px;
      border-radius: 5px;
      background-color: setColor(gray-5);
      &.selected {
        @include setColors(blue-1, white) using ($color) {
          @include selection-border(2px, $color);
        }
      }
      > img {
        margin-right: 8px;
        pointer-events: none;
      }
    }
  }

  &__select {
    display: grid;
    grid-template-columns: repeat(8, minmax(0, 1fr));
    gap: 10px;
    margin: 0 2px;
    > div {
      position: relative;
      width: 100%;
      height: 0;
      padding-top: 100%;
      > img:not(.pro) {
        @include selection-border(1px, gray-5);
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        top: 0;
        border-radius: 4px;
        transition: all 0.3s;
        pointer-events: none;
        &.selected {
          @include setColors(blue-1, white) using ($color) {
            @include selection-border(2px, $color);
          }
        }
      }
      .pro {
        top: 2px;
        left: 2px;
      }
    }
  }

  &__color {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  &__img {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    border-radius: 2px;
    overflow: hidden;
    > img {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
    }
    > div { // dark mask on img
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
    }
  }

  &__reset {
    margin: 6px auto 0;
  }
}
</style>
