<template lang="pug">
div(class="popup bg-white")
  component(v-if="component"
    :is="component"
    v-click-outside="vcoConfig"
    :updateOptions="sharedUpdateOptions"
    :currPage="currPage"
    v-bind="props"
    @close="close")
</template>

<script lang="ts">
// import PopupAlign from '@/components/popup/PopupAlign.vue'
// import PopupDeleteAccount from '@/components/popup/PopupDeleteAccount.vue'
// import PopupFile from '@/components/popup/PopupFile.vue'
// import PopupFlip from '@/components/popup/PopupFlip.vue'
// import PopupGuideline from '@/components/popup/PopupGuideline.vue'
import PopupIcon from '@/components/popup/PopupIcon.vue'
// import PopupLayer from '@/components/popup/PopupLayer.vue'
// import PopupLineTemplate from '@/components/popup/PopupLineTemplate.vue'
// import PopupOrder from '@/components/popup/PopupOrder.vue'
// import PopupPage from '@/components/popup/PopupPage.vue'
// import PopupPageScale from '@/components/popup/PopupPageScale.vue'
// import PopupPayment from '@/components/popup/PopupPayment.vue'
// import PopupReplace from '@/components/popup/PopupReplace.vue'
// import PopupSlider from '@/components/popup/PopupSlider.vue'
// import PopupSubmit from '@/components/popup/PopupSubmit.vue'
import { IPage } from '@nu/vivi-lib/interfaces/page'
import { IPopupComponent, IPopupOptions } from '@nu/vivi-lib/interfaces/popup'
import modalUtils from '@nu/vivi-lib/utils/modalUtils'
import pageUtils from '@nu/vivi-lib/utils/pageUtils'
import popupUtils from '@nu/vivi-lib/utils/popupUtils'
import uploadUtils from '@nu/vivi-lib/utils/uploadUtils'
import vClickOutside from 'click-outside-vue3'
import { defineComponent } from 'vue'
import { mapActions, mapGetters, mapState } from 'vuex'

export default defineComponent({
  emits: [],
  components: {
    // PopupOrder,
    // PopupLayer,
    // PopupAlign,
    // PopupPage,
    // PopupFlip,
    // PopupSlider,
    // PopupFile,
    // PopupLineTemplate,
    // PopupGuideline,
    // PopupPageScale,
    // PopupSubmit,
    // PopupPayment,
    PopupIcon,
    // PopupDeleteAccount,
    // PopupReplace,
  },
  directives: {
    clickOutside: vClickOutside.directive
  },
  data() {
    return {
      vcoConfig: {
        handler: () => {
          popupUtils.closePopup()
        },
        middleware: null as unknown,
        events: ['dblclick', 'click', 'contextmenu']
        // events: ['dblclick', 'click', 'contextmenu', 'mousedown']
      }
    }
  },
  computed: {
    ...mapState('user', [
      'roleRaw'
    ]),
    ...mapGetters({
      popupComponent: 'popup/getPopupComponent',
      getPage: 'getPage',
      currSelectedInfo: 'getCurrSelectedInfo',
      isLogin: 'user/isLogin',
      groupId: 'getGroupId',
      groupType: 'getGroupType',
      isOutsourcer: 'user/isOutsourcer',
      showAdminTool: 'user/showAdminTool',
      isAdmin: 'user/isAdmin'
    }),
    component(): string {
      return (this.popupComponent as IPopupComponent).component
    },
    props(): { [key: string]: string } {
      return (this.popupComponent as IPopupComponent).props
    },
    hasDesignId(): boolean {
      return this.currPage.designId !== ''
    },
    sharedUpdateOptions(): Array<IPopupOptions> {
      return [
        {
          icon: 'copy',
          text: '上傳單頁模板',
          shortcutText: '',
          condition: this.showAdminTool && this.isLogin,
          action: () => {
            uploadUtils.uploadTemplate()
          }
        },
        {
          icon: 'copy',
          text: '更新單頁模板',
          shortcutText: '',
          condition: this.showAdminTool && this.hasDesignId && this.isLogin,
          action: () => {
            uploadUtils.updateTemplate()
          }
        },
        {
          icon: 'copy',
          text: '上傳群組模板',
          shortcutText: '',
          condition: this.showAdminTool && !this.isOutsourcer && this.isLogin && pageUtils.getPages.length > 1,
          action: () => {
            uploadUtils.uploadGroupDesign(0, 0)
          }
        },
        {
          icon: 'copy',
          text: '更新群組模板',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 0,
          action: () => {
            uploadUtils.uploadGroupDesign(1, 0)
          }
        },
        {
          icon: 'copy',
          text: '刪除群組模板',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 0,
          action: () => {
            modalUtils.setModalInfo(
              '確認刪除群組模板？',
              [],
              {
                msg: '',
                action: () => {
                  uploadUtils.uploadGroupDesign(1, 0, true)
                }
              }
            )
          }
        },
        {
          icon: 'copy',
          text: '上傳詳情頁模板',
          shortcutText: '',
          condition: this.showAdminTool && !this.isOutsourcer && this.isLogin && pageUtils.getPages.length > 1,
          action: () => {
            uploadUtils.uploadGroupDesign(0, 1)
          }
        },
        {
          icon: 'copy',
          text: '更新詳情頁模板',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 1,
          action: () => {
            uploadUtils.uploadGroupDesign(1, 1)
          }
        },
        {
          icon: 'copy',
          text: '刪除詳情頁模板',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 1,
          action: () => {
            uploadUtils.uploadGroupDesign(1, 1, true)
          }
        },
        {
          icon: 'copy',
          text: '更新群組成詳情頁',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 0,
          action: () => {
            uploadUtils.uploadGroupDesign(1, 1)
          }
        },
        {
          icon: 'copy',
          text: '更新詳情頁成群組',
          shortcutText: '',
          condition: this.groupId && this.showAdminTool && !this.isOutsourcer && this.isLogin && this.groupType === 1,
          action: () => {
            uploadUtils.uploadGroupDesign(1, 0)
          }
        },
        {
          icon: 'copy',
          text: '上傳單頁模板(不檢查)',
          shortcutText: '',
          condition: this.showAdminTool && this.isLogin && (this.isAdmin && !this.isOutsourcer),
          action: () => {
            uploadUtils.uploadTemplate(true)
          }
        }
        // {
        //   icon: 'copy',
        //   text: '測試用',
        //   shortcutText: '',
        //   condition: true,
        //   action: () => {
        //     generalUtils.test()
        //   }
        // }
      ]
    },
    currPage(): IPage {
      return this.getPage(pageUtils.currFocusPageIndex)
    }
  },
  mounted() {
    this.vcoConfig.middleware = this.middleware
  },
  methods: {
    ...mapActions({
      closePopup: 'popup/closePopup'
    }),
    middleware(e: MouseEvent) { // These component controll v-click-o by themself.
      if (['popup-payment', 'popup-icon'].includes(this.component)) return false
      // For "Upload image" btn in popup, which is implement with click #upload btn by js.
      return (e.target as HTMLElement | null)?.id !== 'upload'
    },
    async close() {
      await (this.popupComponent as IPopupComponent).closeHandler()
      this.closePopup()
    }
  }
})
</script>

<style lang="scss" scoped>
.popup {
  width: initial;
  height: initial;
  border-radius: 5px;
  position: absolute;
  left: 0;
  top: 0;
  z-index: setZindex("popup");
  box-shadow: 0px 0px 7px setColor(gray-1, 0.25);
  &__item {
    display: flex;
    align-items: center;
    transition: background-color 0.1s ease-in;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    &:hover {
      background-color: setColor(blue-3, 0.5);
    }
    &:active {
      background-color: setColor(blue-3);
    }
    > span {
      font-size: 0.75rem;
    }
  }

  &__hr {
    margin: 0.375rem 0;
    border: none;
    border-bottom: 1px solid setColor(gray-4);
  }
}
</style>
