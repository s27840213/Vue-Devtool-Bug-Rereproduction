<template lang="pug">
div(class="overflow-container"
    :style="pageStyles")
  div(class="full-size" :style="stylesWith3DPreserve")
    div(:class="['full-size', 'page-content']"
        :style="pageContentStyles"
        ref="page-content"
        @drop.prevent="onDrop"
        @dragover.prevent
        @dragenter.prevent
        @contextmenu.prevent
        @click.right.stop="onRightClick"
        @dblclick="pageDblClickHandler()"
        @tap="tapPageContent")
      //- @dblclick will not be trigger in mobile, use @tap + doubleTapUtils instead.
      div(class="content full-size" :class="`nu-page-content-${pageIndex}`" :style="contentStyles")
        div(v-if="noBg" class="page-content__pseudo-bg"
          @mousedown.left.stop="pageClickHandler()")
        nu-bg-image(v-else
            :image="config.backgroundImage"
            :pageIndex="pageIndex"
            :page="config"
            :color="config.backgroundColor"
            :key="config.backgroundImage.config.id"
            @mousedown.left="pageClickHandler()"
            :contentScaleRatio="contentScaleRatio"
            :padding="contentStyles.margin")
        div(class="layers-wrapper" :class="{'preserve3D': !isTouchDevice && isMultipleSelect}")
          nu-layer(
            v-for="(layer,index) in config.layers"
            :key="layer.id"
            :dataIndex="`${index}`"
            :dataPindex="`${pageIndex}`"
            :snapUtils="snapUtils"
            :layerIndex="index"
            :pageIndex="pageIndex"
            :page="config"
            :config="layer"
            :contentScaleRatio="contentScaleRatio"
            :forceRender="forceRender"
            :lazyLoadTarget="lazyLoadTarget"
            :inPreview="inPreview")
      div(v-if="isShowBleed" class="bleed-line" :style="bleedLineStyles")
      div(v-if="userId === 'backendRendering' && backendRenderParams.isTrim" class="trim")
        div(class="trim__tl" :style="trimStyles.tl")
        div(class="trim__tr" :style="trimStyles.tr")
        div(class="trim__bl" :style="trimStyles.bl")
        div(class="trim__br" :style="trimStyles.br")
</template>

<script lang="ts">
import NuBgImage from '@/components/editor/global/NuBgImage.vue'
import i18n from '@nu/vivi-lib/i18n'
import { ICurrSelectedInfo } from '@/interfaces/editor'
import doubleTapUtils from '@/utils/doubleTapUtils'
import DragUtils from '@/utils/dragUtils'
import editorUtils from '@/utils/editorUtils'
import generalUtils from '@/utils/generalUtils'
import groupUtils from '@/utils/groupUtils'
import modalUtils from '@/utils/modalUtils'
import networkUtils from '@/utils/networkUtils'
import pageUtils from '@/utils/pageUtils'
import popupUtils from '@/utils/popupUtils'
import uploadUtils from '@/utils/uploadUtils'
import vivistickerUtils from '@nu/vivi-lib/utils/vivistickerUtils'
import { notify } from '@kyvg/vue3-notification'
import { IPage } from '@nu/vivi-lib/interfaces/page'
import { SidebarPanelType } from '@nu/vivi-lib/store/types'
import { defineComponent, PropType } from 'vue'
import { mapGetters, mapMutations, mapState } from 'vuex'

export default defineComponent({
  emits: [],
  components: {
    NuBgImage
  },
  props: {
    snapUtils: Object,
    config: {
      type: Object as PropType<IPage>,
      required: true
    },
    pageIndex: {
      type: Number,
      required: true
    },
    noBg: {
      type: Boolean,
      default: false
    },
    contentScaleRatio: {
      default: 1,
      type: Number
    },
    forceRender: {
      default: false,
      type: Boolean
    },
    lazyLoadTarget: {
      type: String,
      default: '.editor-view'
    },
    inPreview: {
      default: false,
      type: Boolean
    }
  },
  data() {
    return {
      dragUtils: new DragUtils()
    }
  },
  computed: {
    ...mapGetters({
      isProcessImgShadow: 'shadow/isProcessing',
      isUploadImgShadow: 'shadow/isUploading',
      currSelectedInfo: 'getCurrSelectedInfo',
      scaleRatio: 'getPageScaleRatio',
      getCurrFunctionPanelType: 'getCurrFunctionPanelType',
      isUploadingShadowImg: 'shadow/isUploading',
      isHandling: 'shadow/isHandling',
      isShowPagePanel: 'page/getShowPagePanel',
      currSelectedPageIndex: 'getCurrSelectedPageIndex'
    }),
    ...mapGetters('imgControl', {
      isImgCtrl: 'isImgCtrl'
    }),
    ...mapState('user', ['imgSizeMap', 'userId', 'verUni', 'backendRenderParams']),
    ...mapState('shadow', ['uploadId', 'handleId', 'uploadShadowImgs']),
    isHandleShadow(): boolean {
      return this.isProcessImgShadow || this.isUploadImgShadow
    },
    pageStyles(): { [index: string]: string } {
      const _f = this.contentScaleRatio * (this.inPreview || !this.$isTouchDevice() ? 1 : this.scaleRatio * 0.01)
      return {
        width: `${this.config.width * _f + this.margin.right}px`,
        height: `${this.config.height * _f + this.margin.bottom}px`,
        transformStyle: pageUtils._3dEnabledPageIndex === this.pageIndex ? 'preserve-3d' : ''
      }
    },
    pageContentStyles(): { [index: string]: string } {
      return {
        transformStyle: pageUtils._3dEnabledPageIndex === this.pageIndex ? 'preserve-3d' : ''
      }
    },
    stylesWith3DPreserve(): { [index: string]: string } {
      return {
        transformStyle: pageUtils._3dEnabledPageIndex === this.pageIndex ? 'preserve-3d' : ''
      }
    },
    isShowBleed() {
      if (this.userId === 'backendRendering') return false
      return this.config.isEnableBleed
    },
    contentStyles(): {[key: string]: string} {
      if (!this.config.isEnableBleed) {
        return {
          padding: [
            '0px',
            this.margin.right + 'px',
            this.margin.bottom + 'px',
            '0px'
          ].join(' ')
        }
      }
      return {
        width: (this.config.width - this.config.bleeds.left - this.config.bleeds.right) * this.contentScaleRatio + 'px',
        height: (this.config.height - this.config.bleeds.top - this.config.bleeds.bottom) * this.contentScaleRatio + 'px',
        margin: [
          this.config.bleeds.top * this.contentScaleRatio + 'px',
          this.config.bleeds.right * this.contentScaleRatio + this.margin.right + 'px',
          this.config.bleeds.bottom * this.contentScaleRatio + this.margin.bottom + 'px',
          this.config.bleeds.left * this.contentScaleRatio + 'px'
        ].join(' ')
      }
    },
    bleedLineStyles(): {[key: string]: string} {
      return {
        top: (this.config.bleeds.top - 1) * this.contentScaleRatio + 'px',
        bottom: (this.config.bleeds.bottom - 1) * this.contentScaleRatio + this.margin.bottom + 'px',
        left: (this.config.bleeds.left - 1) * this.contentScaleRatio + 'px',
        right: (this.config.bleeds.right - 1) * this.contentScaleRatio + this.margin.right + 'px',
        border: this.userId === 'backendRendering' ? `${this.contentScaleRatio}px solid white` : `${this.config.isEnableBleed ? this.contentScaleRatio : 0}px dashed white`,
        boxShadow: this.userId === 'backendRendering' ? 'none' : '0 0 3px 1px rgba(0, 0, 0, 0.15)'
      }
    },
    trimStyles(): {[key: string]: {[key: string]: string}} {
      return {
        tl: {
          top: '-2px',
          bottom: `${(this.config.height - this.config.bleeds.top) * this.contentScaleRatio + this.margin.bottom}px`,
          left: '-2px',
          right: `${(this.config.width - this.config.bleeds.left) * this.contentScaleRatio + this.margin.right}px`,
          borderWidth: `${this.contentScaleRatio}px`
        },
        tr: {
          top: '-2px',
          bottom: `${(this.config.height - this.config.bleeds.top) * this.contentScaleRatio + this.margin.bottom}px`,
          left: `${(this.config.width - this.config.bleeds.right) * this.contentScaleRatio}px`,
          right: '-2px',
          borderWidth: `${this.contentScaleRatio}px`
        },
        bl: {
          top: `${(this.config.height - this.config.bleeds.bottom) * this.contentScaleRatio}px`,
          bottom: '-2px',
          left: '-2px',
          right: `${(this.config.width - this.config.bleeds.left) * this.contentScaleRatio + this.margin.right}px`,
          borderWidth: `${this.contentScaleRatio}px`
        },
        br: {
          top: `${(this.config.height - this.config.bleeds.bottom) * this.contentScaleRatio}px`,
          bottom: '-2px',
          left: `${(this.config.width - this.config.bleeds.right) * this.contentScaleRatio}px`,
          right: '-2px',
          borderWidth: `${this.contentScaleRatio}px`
        }
      }
    },
    margin() {
      // additional margin for backend render
      return (this.userId === 'backendRendering' ? this.backendRenderParams.margin : { bottom: 0, right: 0 })
    },
    isTouchDevice(): boolean {
      return generalUtils.isTouchDevice()
    },
    isMultipleSelect(): boolean {
      return (this.currSelectedInfo as ICurrSelectedInfo).layers.length > 1
    }
  },
  methods: {
    ...mapMutations({
      ADD_newLayers: 'ADD_newLayers',
      setCurrActivePageIndex: 'SET_currActivePageIndex',
      setCurrSidebarPanel: 'SET_currSidebarPanelType',
      setDropdown: 'popup/SET_STATE',
      updatePageProps: 'UPDATE_pageProps'
    }),
    onDrop(e: DragEvent) {
      if (!navigator.onLine) {
        networkUtils.notifyNetworkError()
        return
      }
      const dt = e.dataTransfer
      if (e.dataTransfer?.getData('data')) {
        this.dragUtils.itemOnDrop(e, this.pageIndex)
      } else if (dt && dt.files.length !== 0) {
        const files = dt.files
        this.setCurrSidebarPanel(SidebarPanelType.file)
        if (uploadUtils.isLogin) {
          uploadUtils.uploadAsset('image', files, {
            addToPage: true
          })
        } else {
          modalUtils.setModalInfo(`${this.$t('NN0350')}`, [])
        }
      }
    },
    pageClickHandler(): void {
      vivistickerUtils.deselect()
    },
    onRightClick(event: MouseEvent) {
      if (this.$isTouchDevice()) {
        return
      }

      this.setCurrActivePageIndex(this.pageIndex)
      if (!this.isHandleShadow) {
        groupUtils.deselect()
      }
      popupUtils.openPopup('page', { event })
    },
    tapPageContent(e: Event): void {
      const target = e.target as HTMLElement
      if (!target.matches('.nu-background-image img')) return
      doubleTapUtils.click(e, { doubleClickCallback: this.pageDblClickHandler })
    },
    pageDblClickHandler(): void {
      if (this.isHandleShadow) {
        return
      }
      const { srcObj, locked } = this.config.backgroundImage.config
      if ((srcObj?.assetId ?? '') !== '' && !locked) {
        pageUtils.startBackgroundImageControl(this.pageIndex)
        editorUtils.setCurrActivePanel('crop')
      }
      if ((srcObj?.assetId ?? '') !== '' && locked) {
        notify({ group: 'copy', text: i18n.global.tc('NN0804') })
      }
    },
  }
})
</script>

<style lang="scss" scoped>
.overflow-container {
  position: relative;
  overflow: hidden; // Fallback for older version browser that doesn't support clip.
  overflow: clip; // Clip can prevent any scroll, include programing scroll.
  transform-origin: 0 0;
}

.page-content {
  position: absolute;
  box-sizing: border-box;
  background-repeat: no-repeat;
  &__pseudo-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
}

.pages-loading {
  width: 100%;
  height: 100%;
  background-color: setColor(gray-4);
}

.content {
  position: absolute;
  left: 0;
  top: 0;
  transform-style: preserve-3d;
}

.bleed-line {
  pointer-events: none;
  position: absolute;
  left: 0px;
  top: 0px;
  box-sizing: border-box;
  border: 1px solid white
}

.layers-wrapper {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.trim {
  >div {
  position: absolute;
  left: 0px;
  top: 0px;
  box-sizing: border-box;
  border: 1px solid setColor(gray-2)
  }
}
</style>
